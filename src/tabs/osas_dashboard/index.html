<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervisor Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>

  <link
    href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">

  <link href="../dist/output.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


</head>

<body class="bg-white-100 font-sans">

  <div class="flex h-screen">
    <!-- Sidebar ----------------------------------------------------------------------------------->


    <aside class="bg-[#f5f5f5] text-[#004a6d] w-64 p-6 h-screen flex flex-col fixed static">
      <!-- Logo -->
      <h1 class="text-5xl font-bold mb-6" style="font-family: 'Baloo 2', sans-serif;">
        <span style="color: #289DD2;">assist</span><span style="color: #e29830;">ify</span>
      </h1>

      <!-- Navigation -->
      <nav class="flex-grow flex flex-col justify-between">
        <ul>
          <!-- Home -->
          <li class="mb-4 flex items-center">
            <svg class="h-6 w-6 text-[#289DD2] mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <a href="#home" class="hover:text-gray-600" title="Home">Home</a>
          </li>

          <!-- Working students -->
          <li class="mb-4 flex items-center">
            <svg class="h-6 w-6 text-[#289DD2] mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z"></path>
              <path d="M9 5H7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2V7a2 2 0 0 0 -2 -2h-2">
              </path>
              <rect x="9" y="3" width="6" height="4" rx="2"></rect>
            </svg>
            <a href="#supers" class="hover:text-gray-600" title="Working Students">Supervisors</a>
          </li>

          <!-- Working students -->
          <li class="mb-4 flex items-center">
            <svg class="h-6 w-6 text-[#289DD2] mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z"></path>
              <path d="M9 5H7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2V7a2 2 0 0 0 -2 -2h-2">
              </path>
              <rect x="9" y="3" width="6" height="4" rx="2"></rect>
            </svg>
            <a href="#studs" class="hover:text-gray-600" title="Working Students">Working Scholars</a>
          </li>

          <!-- Tasks -->
          <li class="mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <rect width="24" height="24" fill="none" />
              <g fill="none" fill-rule="evenodd">
                <path
                  d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z" />
                <path fill="#289DD2"
                  d="M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm0 2h14v14H5zm11.95 4.795a1 1 0 1 0-1.414-1.414l-4.95 4.95l-2.121-2.121a1 1 0 0 0-1.415 1.414l2.758 2.758a1.1 1.1 0 0 0 1.556 0z" />
              </g>
            </svg>
            <a href="#dtrs" class="hover:text-gray-600" title="Tasks">Student DTR</a>
          </li>

        </ul>

        <ul>
          <!-- Profile -->
          <li class="mb-4 flex items-center">
            <div class="bg-gray-100 flex justify-left">
              <ul class="mb-4 flex flex-col items-start">
                <li class="mb-4 flex items-center relative">

                  <button id="logout-btn"
                    class="block px-4 py-2 w-full text-left text-gray-700 hover:bg-gray-100">Logout</button>
                </li>
              </ul>
            </div>
          </li>

        </ul>
      </nav>
    </aside>

    <!-- Main Section -->
    <div class="flex-1 p-6 ml-64" id="home">
      <!-- Welcome Section -->
      <div class="bg-[#289dd2] text-white rounded-lg p-10 mb-6">
        <div class="flex justify-between">
          <div class="flex flex-col justify-center">
            <h2 class="text-6xl font-bold" style="font-family: 'Baloo 2', sans-serif;">Welcome <span
                id="osas-name">Supervisor</span>! ðŸ‘‹</h2>
            <p class="text-xl mt-4" style="font-family: 'Baloo 2', sans-serif;" id="welcome-message">We're excited to
              have you here. Let's make today a productive and successful one! ðŸŽ‰</p>
          </div>


        </div>
      </div>



      <!-- SUPERVISORS -->
      <div class="bg-[#F2F1EC] p-10 rounded-lg shadow-md mb-6" id="supers">
        <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Supervisors</h3>
        <div class="flex flex-wrap justify-start gap-4 p-4" id="supervisors-container">
          <!-- Supervisors will be populated here dynamically -->
        </div>
        <!-- Add Supervisor Button -->
        <button id="add-supervisor-btn"
          class="bg-orange-400 text-white p-3 rounded-lg font-semibold hover:bg-[#2179A2]">
          Add Supervisor
        </button>

        <!-- Modal -->
        <div id="add-supervisor-modal"
          class="fixed inset-0 bg-gray-500 bg-opacity-50 flex justify-center items-center hidden">
          <div class="bg-white p-6 rounded-lg w-2/3 shadow-lg">
            <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Add
              Supervisor</h3>

            <!-- New supervisor form -->
            <form id="supervisor-form">
              <div class="mb-4">
                <label for="new_super_first_name" class="block text-gray-700">First Name</label>
                <input type="text" id="new_super_first_name" name="new_super_first_name"
                  class="w-full px-4 py-2 rounded-lg border border-gray-300" required>
              </div>
              <div class="mb-4">
                <label for="new_super_last_name" class="block text-gray-700">Last Name</label>
                <input type="text" id="new_super_last_name" name="new_super_last_name"
                  class="w-full px-4 py-2 rounded-lg border border-gray-300" required>
              </div>
              <div class="mb-4">
                <label for="new_super_email" class="block text-gray-700">Email</label>
                <input type="email" id="new_super_email" name="new_super_email"
                  class="w-full px-4 py-2 rounded-lg border border-gray-300" required>
              </div>
              <div class="mb-4">
                <label for="new_super_password" class="block text-gray-700">Password</label>
                <input type="password" id="new_super_password" name="new_super_password"
                  class="w-full px-4 py-2 rounded-lg border border-gray-300" required>
              </div>
            </form>

            <div class="flex justify-end space-x-4 mt-4">
              <button type="button" id="close-modal-btn"
                class="bg-gray-300 text-white p-2 rounded-lg hover:bg-gray-400">
                Close
              </button>
              <button type="submit" id="submit-supervisor"
                class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">
                Add Supervisor
              </button>
            </div>

          </div>
        </div>

      </div>


      <!-- WORKING SCHOLARS -->
      <div class="bg-[#F2F1EC] p-10 rounded-lg shadow-md mb-6" id="studs">
        <div class="grid grid-cols-2 gap-4">
          <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Working
            Scholars
          </h3>

        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-[#F2F1EC] p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-2">On Duty</h3>
            <div class="flex items-center space-x-4" id="on-duty-container">
              <!-- On Duty students will be inserted here dynamically -->
            </div>
          </div>

          <div class="bg-[#F2F1EC] p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-2">Off Duty</h3>
            <div class="grid grid-cols-2 gap-4" id="off-duty-container">
              <!-- Off Duty students will be inserted here dynamically -->
            </div>

          </div>
        </div>


      </div>


      <!-- STUDENT DTR -->
      <div class="bg-[#F2F1EC] p-10 rounded-lg shadow-md mb-6" id="dtrs">
        <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">DAILY TIME RECORD
        </h3>

        <!-- Student Daily Time Record Section -->
        <div class="bg-[#ededed] shadow rounded-lg p-10 mb-6">
          <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Student Daily
            Time Record</h3>

          <script>
            // Display current date
            const currentDate = new Date();
            const currentMonthIndex = currentDate.getMonth();
            const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
            const currentDay = currentDate.getDate();
            const currentYear = currentDate.getFullYear();
            const formattedDate = `${currentMonth} ${currentDay}, ${currentYear}`;

            // Update the label to show the current date
            const currentDateLabel = document.getElementById('current-date-label');
            currentDateLabel.textContent = `(${formattedDate})`;

            // Set the selected month to the current month
            const monthSelect = document.getElementById('month-select');
            monthSelect.selectedIndex = currentMonthIndex;
          </script>

          <div class="bg-[#ededed] shadow rounded-lg p-6 mb-6">
            <table class="w-full text-left table-auto">
              <thead>
                <tr class="text-[#004A6D]" style="font-family: 'Baloo 2', sans-serif;">
                  <th class="border-b-2 border-gray-300 pb-2 px-3 text-sm">Working Scholar</th>
                  <th class="border-b-2 border-gray-300 pb-2 px-3 text-sm">Login</th>
                  <th class="border-b-2 border-gray-300 pb-2 px-3 text-sm">Logout</th>
                  <th class="border-b-2 border-gray-300 pb-2 px-3 text-sm">Hours</th>
                </tr>
              </thead>
              <tbody id="time-log-table-body">
                <!-- Data will be populated here via AJAX -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!--  -->

    </div>
  </div>

  <!-- jQuery and Bootstrap Modal Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    $('#logout-btn').on('click', function () {
      document.cookie = "osas_id=" + "" + "; path=/; SameSite=Lax";
      window.location.reload()
    });

    // Function to get a cookie by name
    function getCookie(name) {
      let cookieArr = document.cookie.split(';');
      for (let i = 0; i < cookieArr.length; i++) {
        let cookie = cookieArr[i].trim();
        if (cookie.indexOf(name + '=') == 0) {
          return cookie.substring(name.length + 1);
        }
      }
      return null;
    }



    $(document).ready(function () {
      // Fetch supervisors from the API
      $.ajax({
        url: 'http://127.0.0.1:8000/api/supervisors',
        type: 'GET',
        success: function (supervisors) {
          // Fetch students to count working scholars for each supervisor
          $.ajax({
            url: 'http://127.0.0.1:8000/api/students',
            type: 'GET',
            success: function (students) {
              // Iterate through supervisors and count working scholars
              supervisors.forEach((supervisor) => {
                console.log(supervisor, students)
                const supervisorStudents = students.data.filter(student => student.supervisor_id === supervisor.id);
                const workingScholarsCount = supervisorStudents.length;

                // Create the supervisor button for the UI
                const supervisorButton = `
              <button class="flex flex-col items-center justify-center bg-[#e29830] text-white rounded-lg shadow-lg p-4 hover:bg-[#289dd2] transition">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 mb-2">
                  <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" />
                </svg>
                <h2 class="text-lg font-bold">${supervisor.first_name} ${supervisor.last_name}</h2>
                <p class="text-sm">Working Scholars: ${workingScholarsCount}</p>
                <p class="text-sm italic">Department: ${supervisor.role}</p>
              </button>
            `;

                // Append the supervisor button to the container
                $('#supervisors-container').append(supervisorButton);
              });
            },
            error: function (xhr) {
              alert('Failed to fetch students: ' + xhr.responseJSON.message);
            }
          });
        },
        error: function (xhr) {
          alert('Failed to fetch supervisors: ' + xhr.responseJSON.message);
        }
      });


      // Open modal when Add Supervisor button is clicked
      $('#add-supervisor-btn').click(function () {
        $('#add-supervisor-modal').removeClass('hidden');  // Show modal
      });

      // Close modal when Close button is clicked
      $('#close-modal-btn').click(function () {
        $('#add-supervisor-modal').addClass('hidden');  // Hide modal
      });

      // Handle form submission via AJAX when the submit button is clicked
      $('#submit-supervisor').click(function (e) {
        e.preventDefault();  // Prevent the form from submitting the default way

        // Collect form data
        var formData = {
          first_name: $('#new_super_first_name').val(),
          last_name: $('#new_super_last_name').val(),
          email: $('#new_super_email').val(),
          password: $('#new_super_password').val(),
          role: 'Supervisor',
        };

        console.log(formData)

        // Send AJAX request to the controller
        $.ajax({
          url: 'http://127.0.0.1:8000/api/supervisors',  // Your endpoint for creating a supervisor
          method: 'POST',
          data: formData,
          dataType: 'json',
          success: function (response) {
            // Check if supervisor was created successfully
            if (response.message === 'Supervisor created successfully') {
              alert('Supervisor added successfully!');
              $('#add-supervisor-modal').addClass('hidden');  // Close modal
              window.location.reload()

              // Optionally, you can refresh the supervisor list here
              // refreshSupervisors();  // Example function to reload the supervisors list
            }
          },
          error: function (xhr) {
            // Handle error response
            var errors = xhr.responseJSON.errors;
            var errorMessage = '';

            // Display error messages
            for (var key in errors) {
              if (errors.hasOwnProperty(key)) {
                errorMessage += errors[key].join('<br>');
              }
            }
            alert('Error: ' + errorMessage);
          }
        });
      });




      // Fetch time logs from API and populate the table using jQuery
      function fetchTimeLogs() {
        $.ajax({
          url: 'http://127.0.0.1:8000/api/time-logs',
          method: 'GET',
          success: function (data) {
            // Clear the table body before appending new rows
            $('#time-log-table-body').empty();

            // Loop through the data and create table rows
            $.each(data, function (index, log) {
              const row = `
            <tr class="text-[#004A6D]" style="font-family: 'Baloo 2', sans-serif;">
              <td class="border-b border-gray-300 pb-2 px-3 text-sm">${log.student.first_name} ${log.student.last_name}</td>
              <td class="border-b border-gray-300 pb-2 px-3 text-sm">${log.check_in}</td>
              <td class="border-b border-gray-300 pb-2 px-3 text-sm">${log.check_out}</td>
              <td class="border-b border-gray-300 pb-2 px-3 text-sm">${log.total_hours_worked.toFixed(2)} hours</td>
            </tr>
          `;

              // Append the row to the table body
              $('#time-log-table-body').append(row);
            });
          },
          error: function (xhr, status, error) {
            console.error('Error fetching time logs:', error);
          }
        });
      }


      fetchTimeLogs();
    });

























    // Get the supervisor's ID and Role from the cookies
    var osasId = getCookie('osas_id');
    var studentsOfSupervisor;


    $(document).ready(function () {
      if (osasId) {
        // Make a GET request to retrieve the supervisor's data using the ID
        $.ajax({
          type: 'GET',
          url: 'http://127.0.0.1:8000/api/osas/' + osasId,
          success: function (data) {



            // Update the DOM with the supervisor's name and a welcome message
            $('#osas-name').text(data.name);
            $('#welcome-message').text('We are excited to have you back! Explore the dashboard for updates.');
          },
          error: function (xhr, status, error) {
            console.error(xhr.responseText);
            alert("Error loading supervisor data.");
          }
        });
      } else {
        alert("No supervisor data found in cookies. Please log in again.");
        window.location.href = '/src/auth/osaslogin'; // Redirect to login page if no cookie is found
      }






      // GET STUDENTS
      $.ajax({
        url: 'http://127.0.0.1:8000/api/students', // Adjust this route if needed
        type: 'GET',

        success: function (response) {
          const students = response.data; // Assuming the response has a "data" key with the students

          // Clear both containers for on duty and off duty students
          $('#on-duty-container').empty();
          $('#off-duty-container').empty();

          // Create variables to store students on duty and off duty
          let onDuty = [];
          let offDuty = [];

          // Loop through each student and create HTML for them
          students.forEach(function (student) {
            $.ajax({
              url: `http://127.0.0.1:8000/api/time-logs?student_id=${student.id}`, // API call to get time logs
              type: 'GET',
              success: function (timeLogsResponse) {
                const timeLogs = timeLogsResponse;

                if (timeLogs.length > 0 && timeLogs[0].check_out === null) {
                  // Student is on duty
                  onDuty.push(student);


                  // Create a new Date object from the check_in value
                  const checkInTime = new Date(timeLogs[0].check_in);

                  // Extract only the time portion using toLocaleTimeString for formatting
                  const formattedCheckInTime = checkInTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                  // Create the On Duty student div
                  const studentDiv = `
                    <div class="bg-[#289DD2] text-white p-4 rounded-lg text-center">
                      <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
                      <p class="font-bold">${student.first_name} ${student.last_name}</p>
                      <p class="font-normal">Check-in: ${formattedCheckInTime}</p> <!-- Display the check-in time -->
                    </div>
                  `;

                  // Append the student div to the "On Duty" container
                  $('#on-duty-container').append(studentDiv);

                } else {
                  // Student is off duty
                  offDuty.push(student);


                  if (timeLogs.length === 0) {
                    // Create the Off Duty student div with the formatted times
                    const studentDiv = `
                    <div class="bg-white text-[#289DD2] p-4 rounded-lg text-center">
                      <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
                      <p class="font-bold">${student.first_name} ${student.last_name}</p>
                      <p class="font-normal">Last Duty Date: No Duties on record</p> <!-- Display the last duty date -->
                    </div>
                  `;

                    // Append the student div to the "Off Duty" container
                    $('#off-duty-container').append(studentDiv);
                  } else {
                    // Get the latest time log (last one in the array)
                    const lastTimeLog = timeLogs[0];

                    // Extract the date, check-in time, and check-out time
                    const checkInDate = new Date(lastTimeLog.check_in);
                    const checkInTime = checkInDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // If check_out is not null, format the check-out time
                    const checkOutTime = lastTimeLog.check_out ? new Date(lastTimeLog.check_out).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "Not yet checked out";

                    // Extract the date from check_in for the last duty date
                    const dutyDate = checkInDate.toLocaleDateString(); // This will show the date (e.g., 12/07/2024)


                    // Create the Off Duty student div with the formatted times
                    const studentDiv = `
                    <div class="bg-white text-[#289DD2] p-4 rounded-lg text-center">
                      <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
                      <p class="font-bold">${student.first_name} ${student.last_name}</p>
                      <p class="font-normal">Last Duty Date: ${dutyDate}</p> <!-- Display the last duty date -->
                      <p class="font-normal ">${checkInTime} - ${checkOutTime}</p> <!-- Display check-out time or 'Not yet checked out' -->
                    </div>
                  `;

                    // Append the student div to the "Off Duty" container
                    $('#off-duty-container').append(studentDiv);
                  }
                }

                // if (onDuty.length === 0) {
                //   $('#on-duty-container').html('<p class="text-center text-gray-500">No students on duty.</p>');
                // }

                // // Check if there are no students off duty
                // if (offDuty.length === 0) {
                //   $('#off-duty-container').html('<p class="text-center text-gray-500">No students off duty.</p>');
                // }
              },
              error: function (xhr, status, error) {
                console.error("Error fetching time logs for student:", error);
              }

            });
          });
        },
        error: function (xhr, status, error) {
          // Handle error
          console.error("Error fetching students:", error);
        }
      });








    })
  </script>

</body>

</html>