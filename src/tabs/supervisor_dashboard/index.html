<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervisor Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>

  <link
    href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400..800&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">

  <link href="../dist/output.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


</head>

<body class="bg-white-100 font-sans">

  <div class="flex h-screen">
    <!-- Sidebar ----------------------------------------------------------------------------------->


    <aside class="bg-[#f5f5f5] text-[#004a6d] w-64 p-6 h-screen flex flex-col fixed static">
      <!-- Logo -->
      <h1 class="text-5xl font-bold mb-6" style="font-family: 'Baloo 2', sans-serif;">
        <span style="color: #289DD2;">assist</span><span style="color: #e29830;">ify</span>
      </h1>

      <!-- Navigation -->
      <nav class="flex-grow flex flex-col justify-between">
        <ul>
          <!-- Home -->
          <li class="mb-4 flex items-center">
            <svg class="h-6 w-6 text-[#289DD2] mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <a href="#home" class="hover:text-gray-600" title="Home">Home</a>
          </li>

          <!-- Working students -->
          <li class="mb-4 flex items-center">
            <svg class="h-6 w-6 text-[#289DD2] mr-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z"></path>
              <path d="M9 5H7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2V7a2 2 0 0 0 -2 -2h-2">
              </path>
              <rect x="9" y="3" width="6" height="4" rx="2"></rect>
            </svg>
            <a href="#studs" class="hover:text-gray-600" title="Working Students">Working Scholars</a>
          </li>

          <!-- Tasks -->
          <li class="mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <rect width="24" height="24" fill="none" />
              <g fill="none" fill-rule="evenodd">
                <path
                  d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z" />
                <path fill="#289DD2"
                  d="M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm0 2h14v14H5zm11.95 4.795a1 1 0 1 0-1.414-1.414l-4.95 4.95l-2.121-2.121a1 1 0 0 0-1.415 1.414l2.758 2.758a1.1 1.1 0 0 0 1.556 0z" />
              </g>
            </svg>
            <a href="#tasks" class="hover:text-gray-600" title="Tasks">Tasks</a>
          </li>

        </ul>

        <ul>
          <!-- Profile -->
          <li class="mb-4 flex items-center">
            <div class="bg-gray-100 flex justify-left">
              <ul class="mb-4 flex flex-col items-start">
                <li class="mb-4 flex items-center relative">

                  <button id="logout-btn"
                    class="block px-4 py-2 w-full text-left text-gray-700 hover:bg-gray-100">Logout</button>
                </li>
              </ul>
            </div>
          </li>

        </ul>
      </nav>
    </aside>

    <!-- Main Section -->
    <div class="flex-1 p-6 ml-64" id="home">
      <!-- Welcome Section -->
      <div class="bg-[#289dd2] text-white rounded-lg p-10 mb-6">
        <div class="flex justify-between">
          <div class="flex flex-col justify-center">
            <h2 class="text-6xl font-bold" style="font-family: 'Baloo 2', sans-serif;">Welcome <span
                id="supervisor-name">Supervisor</span>! ðŸ‘‹</h2>
            <p class="text-xl mt-4" style="font-family: 'Baloo 2', sans-serif;" id="welcome-message">We're excited to
              have you here. Let's make today a productive and successful one! ðŸŽ‰</p>
          </div>

          <div>
            <div class="max-w-sm w-full bg-white shadow-lg rounded-lg overflow-hidden">
              <div class="p-6 text-center">
                <h2 id="name" class="text-2xl font-semibold text-gray-700" style="font-family: 'Baloo 2', sans-serif;">
                </h2>
                <p id="department" class="text-sm text-gray-500"></p>
              </div>
              <div class="p-6 border-t">
                <div class="flex items-center space-x-2 text-gray-600 mb-3">
                  <i class="fas fa-envelope text-blue-500"></i>
                  <span id="email" class="text-sm"></span>
                </div>
                <div class="flex items-center space-x-2 text-gray-600">
                  <i class="fas fa-calendar-alt text-blue-500"></i>
                  <span id="created_at" class="text-sm"></span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- WORKING SCHOLARS -->
      <div class="bg-[#F2F1EC] p-10 rounded-lg shadow-md mb-6" id="studs">
        <div class="grid grid-cols-2 gap-4">
          <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Working
            Scholars
          </h3>

          <!-- Add Student Button -->
          <button id="add-student-btn" class="bg-orange-400 text-white p-3 rounded-lg font-semibold hover:bg-[#2179A2]">
            Add Student
          </button>


          <!-- Modal -->
          <div id="add-student-modal"
            class="fixed inset-0 bg-gray-500 bg-opacity-50 flex justify-center items-center hidden">
            <div class="bg-white p-6 rounded-lg w-2/3 shadow-lg">
              <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Add Student
              </h3>

              <!-- Students list will be dynamically inserted here -->
              <div id="students-list" class="gap-4 grid grid-cols-4">
                <!-- Students will be appended here -->
              </div>

              <div class="flex justify-end space-x-4 mt-4">
                <button type="button" id="close-modal-btn"
                  class="bg-gray-300 text-white p-2 rounded-lg hover:bg-gray-400">
                  Close
                </button>
              </div>
            </div>
          </div>

        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="bg-[#F2F1EC] p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-2">On Duty</h3>
            <div class="flex items-center space-x-4" id="on-duty-container">
              <!-- On Duty students will be inserted here dynamically -->
            </div>
          </div>

          <div class="bg-[#F2F1EC] p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-2">Off Duty</h3>
            <div class="grid grid-cols-2 gap-4" id="off-duty-container">
              <!-- Off Duty students will be inserted here dynamically -->
            </div>
            <!-- Remove Student Button -->
            <button id="remove-student-btn"
              class=" mt-4 bg-red-400 text-white p-3 rounded-lg font-semibold hover:bg-[#A21B12]">
              Remove a Student
            </button>

            <!-- Modal -->
            <div id="remove-student-modal"
              class="fixed inset-0 bg-gray-500 bg-opacity-50 flex justify-center items-center hidden">
              <div class="bg-white p-6 rounded-lg w-2/3 shadow-lg">
                <h3 class="text-2xl text-[#6D0000] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">Remove
                  Student
                </h3>

                <!-- Students list will be dynamically inserted here -->
                <div id="students-remove-list" class="gap-4 grid grid-cols-4">
                  <!-- Students will be appended here -->
                </div>

                <div class="flex justify-end space-x-4 mt-4">
                  <button type="button" id="close-remove-modal-btn"
                    class="bg-gray-300 text-white p-2 rounded-lg hover:bg-gray-400">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>


      <!-- TASKS -->
      <div class="bg-[#F2F1EC] p-10 rounded-lg shadow-md mb-6" id="tasks">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">
            Tasks</h3>
          <!-- Add Task Button -->
          <button class="bg-[#289DD2] text-white px-4 py-2 rounded-lg" id="addTaskButton">
            Add Task
          </button>


          <div id="addTaskModal"
            class="fixed inset-0 bg-gray-500 bg-opacity-50 flex justify-center items-center hidden">
            <div class="bg-white p-6 rounded-lg w-2/3 shadow-lg">
              <!-- Modal Header -->
              <h3 class="text-2xl text-[#004A6D] font-bold mb-4" style="font-family: 'Baloo 2', sans-serif;">
                Create New Task
              </h3>

              <!-- Task Form -->
              <form id="taskForm" class="space-y-4">
                <!-- Task Description -->
                <div>
                  <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                  <input type="text" id="description" name="description" required
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#004A6D] focus:border-[#004A6D]" />
                </div>

                <!-- Deadline -->
                <div>
                  <label for="deadline" class="block text-sm font-medium text-gray-700">Deadline</label>
                  <input type="date" id="deadline" name="deadline" required
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#004A6D] focus:border-[#004A6D]" />
                </div>

                <!-- Priority -->
                <div>
                  <label for="priority" class="block text-sm font-medium text-gray-700">Priority</label>
                  <select id="priority" name="priority" required
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#004A6D] focus:border-[#004A6D]">
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>

                <!-- Assign to Student -->
                <div>
                  <label for="assigned_to" class="block text-sm font-medium text-gray-700">Assign to Student</label>
                  <select id="assigned_to" name="assigned_to" required
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-[#004A6D] focus:border-[#004A6D]">
                    <!-- Options will be dynamically added here -->
                  </select>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 mt-4">
                  <button type="button" id="closeModalButton"
                    class="bg-gray-300 text-white p-2 rounded-lg hover:bg-gray-400">
                    Close
                  </button>
                  <button type="submit" class="bg-[#004A6D] text-white px-4 py-2 rounded-lg hover:bg-[#003653]">
                    Create Task
                  </button>
                </div>
              </form>
            </div>
          </div>


        </div>
        <table class="w-full text-left">
          <thead>
            <tr>
              <th class="py-2">Description</th>
              <th class="py-2">Deadline</th>
              <th class="py-2">Assigned To</th>
              <th class="py-2">Priority</th>
              <th class="py-2">Status</th>
            </tr>
          </thead>
          <tbody id="task-list">
            <!-- Dynamically generated rows will appear here -->
          </tbody>
        </table>
      </div>





      <!--  -->

    </div>
  </div>

  <!-- jQuery and Bootstrap Modal Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    $('#logout-btn').on('click', function () {
      document.cookie = "supervisor_id=" + "" + "; path=/; SameSite=Lax";
      document.cookie = "supervisor_role=" + "" + "; path=/; SameSite=Lax";

      window.location.reload()
    });

    // Function to get a cookie by name
    function getCookie(name) {
      let cookieArr = document.cookie.split(';');
      for (let i = 0; i < cookieArr.length; i++) {
        let cookie = cookieArr[i].trim();
        if (cookie.indexOf(name + '=') == 0) {
          return cookie.substring(name.length + 1);
        }
      }
      return null;
    }

    // Get the supervisor's ID and Role from the cookies
    var supervisorId = getCookie("supervisor_id");
    var supervisorRole = getCookie("supervisor_role");
    var studentsOfSupervisor;


    $(document).ready(function () {
      if (supervisorId) {
        // Make a GET request to retrieve the supervisor's data using the ID
        $.ajax({
          type: 'GET',
          url: 'http://127.0.0.1:8000/api/supervisors/' + supervisorId,
          success: function (data) {
            // Populate the supervisor's data on the page
            $('#first_name').text(data.first_name);
            $('#last_name').text(data.last_name);
            $('#email').text(data.email);
            $('#role').text(data.role);
            $('#department').text(data.department);  // Assuming you have a department field in the response

            // Populate the profile data using jQuery
            $("#name").text(`${data.first_name} ${data.last_name}`);
            $("#created_at").text(`Created At: ${new Date(data.created_at).toLocaleString()}`);


            const supervisorName = data.first_name;

            // Update the DOM with the supervisor's name and a welcome message
            $('#supervisor-name').text(supervisorName);
            $('#welcome-message').text('We are excited to have you back! Explore the dashboard for updates.');
          },
          error: function (xhr, status, error) {
            console.error(xhr.responseText);
            alert("Error loading supervisor data.");
          }
        });
      } else {
        alert("No supervisor data found in cookies. Please log in again.");
        window.location.href = '/src/auth/supervisorlogin'; // Redirect to login page if no cookie is found
      }






      // GET STUDENTS
      $.ajax({
        url: 'http://127.0.0.1:8000/api/supervisor/students', // Adjust this route if needed
        type: 'POST',
        data: {
          supervisor_id: supervisorId
        },
        success: function (response) {
          const students = response.data; // Assuming the response has a "data" key with the students
          studentsOfSupervisor = students;

          // Clear both containers for on duty and off duty students
          $('#on-duty-container').empty();
          $('#off-duty-container').empty();

          // Create variables to store students on duty and off duty
          let onDuty = [];
          let offDuty = [];

          // Loop through each student and create HTML for them
          students.forEach(function (student) {
            $.ajax({
              url: `http://127.0.0.1:8000/api/time-logs?student_id=${student.id}`, // API call to get time logs
              type: 'GET',
              success: function (timeLogsResponse) {
                const timeLogs = timeLogsResponse;

                if (timeLogs.length > 0 && timeLogs[0].check_out === null) {
                  // Student is on duty
                  onDuty.push(student);


                  // Create a new Date object from the check_in value
                  const checkInTime = new Date(timeLogs[0].check_in);

                  // Extract only the time portion using toLocaleTimeString for formatting
                  const formattedCheckInTime = checkInTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                  // Create the On Duty student div
                  const studentDiv = `
                    <div class="bg-[#289DD2] text-white p-4 rounded-lg text-center">
                      <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
                      <p class="font-bold">${student.first_name} ${student.last_name}</p>
                      <p class="font-normal">Check-in: ${formattedCheckInTime}</p> <!-- Display the check-in time -->
                    </div>
                  `;

                  // Append the student div to the "On Duty" container
                  $('#on-duty-container').append(studentDiv);

                } else {
                  // Student is off duty
                  offDuty.push(student);


                  if (timeLogs.length === 0) {
                    // Create the Off Duty student div with the formatted times
                    const studentDiv = `
                    <div class="bg-white text-[#289DD2] p-4 rounded-lg text-center">
                      <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
                      <p class="font-bold">${student.first_name} ${student.last_name}</p>
                      <p class="font-normal">Last Duty Date: No Duties on record</p> <!-- Display the last duty date -->
                    </div>
                  `;

                    // Append the student div to the "Off Duty" container
                    $('#off-duty-container').append(studentDiv);
                  } else {
                    // Get the latest time log (last one in the array)
                    const lastTimeLog = timeLogs[0];

                    // Extract the date, check-in time, and check-out time
                    const checkInDate = new Date(lastTimeLog.check_in);
                    const checkInTime = checkInDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // If check_out is not null, format the check-out time
                    const checkOutTime = lastTimeLog.check_out ? new Date(lastTimeLog.check_out).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "Not yet checked out";

                    // Extract the date from check_in for the last duty date
                    const dutyDate = checkInDate.toLocaleDateString(); // This will show the date (e.g., 12/07/2024)


                    // Create the Off Duty student div with the formatted times
                    const studentDiv = `
                    <div class="bg-white text-[#289DD2] p-4 rounded-lg text-center">
                      <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
                      <p class="font-bold">${student.first_name} ${student.last_name}</p>
                      <p class="font-normal">Last Duty Date: ${dutyDate}</p> <!-- Display the last duty date -->
                      <p class="font-normal ">${checkInTime} - ${checkOutTime}</p> <!-- Display check-out time or 'Not yet checked out' -->
                    </div>
                  `;

                    // Append the student div to the "Off Duty" container
                    $('#off-duty-container').append(studentDiv);
                  }
                }

                // if (onDuty.length === 0) {
                //   $('#on-duty-container').html('<p class="text-center text-gray-500">No students on duty.</p>');
                // }

                // // Check if there are no students off duty
                // if (offDuty.length === 0) {
                //   $('#off-duty-container').html('<p class="text-center text-gray-500">No students off duty.</p>');
                // }
              },
              error: function (xhr, status, error) {
                console.error("Error fetching time logs for student:", error);
              }

            });
          });
        },
        error: function (xhr, status, error) {
          // Handle error
          console.error("Error fetching students:", error);
        }
      });











      // ADD STUDENT MODAL SCRIPT

      // Open the modal and fetch students with no supervisor
      $('#add-student-btn').click(function () {
        // Show the modal
        $('#add-student-modal').removeClass('hidden');

        // Fetch students from the API
        $.ajax({
          url: 'http://127.0.0.1:8000/api/students', // API to get all students
          type: 'GET',
          success: function (response) {
            const students = response.data; // Assuming response has a "data" key with the list of students

            // Filter out students with no supervisor
            const studentsWithoutSupervisors = students.filter(student => student.supervisor_id === null);

            // Clear the previous student list
            $('#students-list').empty();

            // Check if there are any students without a supervisor
            if (studentsWithoutSupervisors.length === 0) {
              $('#students-list').append('<p class="text-center text-gray-500">No students without supervisors.</p>');
            } else {
              // Loop through the students and display them
              studentsWithoutSupervisors.forEach(function (student) {
                const studentDiv = `
            <div class="bg-[#2179A2] text-white p-4 rounded-lg text-center">
              <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
              <p class="font-bold">${student.first_name} ${student.last_name}</p>
              <p class="font-normal">${student.department}</p>
              <button 
                type="button" 
                class="bg-white text-[#2179A2] mt-2 px-4 py-2 rounded-lg hover:bg-gray-200 add-student-btn" 
                data-student-id="${student.id}">
                Add This
              </button>
            </div>
          `;

                $('#students-list').append(studentDiv);
              });

              // Attach click event to dynamically added buttons
              $('.add-student-btn').click(function () {
                const studentId = $(this).data('student-id');

                // Send AJAX request to update supervisor
                $.ajax({
                  url: `http://127.0.0.1:8000/api/students/${studentId}/assign-supervisor`,
                  type: 'PUT',
                  contentType: 'application/json',
                  data: JSON.stringify({
                    supervisor_id: supervisorId
                  }),
                  success: function (response) {
                    alert(`Supervisor assigned successfully to ${response.student.first_name} ${response.student.last_name}`);
                    // Optionally, refresh the student list or close the modal
                    $(`#add-student-btn[data-student-id="${studentId}"]`).parent().remove();
                    window.location.reload()
                  },
                  error: function (xhr, status, error) {
                    console.error('Error assigning supervisor:', error);
                    alert('Failed to assign supervisor. Please try again.');
                  }
                });
              });
            }
          },
          error: function (xhr, status, error) {
            console.error('Error fetching students:', error);
          }
        });
      });

      // Close the modal
      $('#close-modal-btn').click(function () {
        $('#add-student-modal').addClass('hidden');
      });

      // Optionally, close the modal when clicking outside of it
      $(window).click(function (event) {
        const modal = $('#add-student-modal');
        if ($(event.target).is(modal)) {
          modal.addClass('hidden');
        }
      });

    });












    // REMOVE MODAL SCRIPT

    // Open the modal and fetch students to remove
    $('#remove-student-btn').click(function () {
      // Show the modal
      $('#remove-student-modal').removeClass('hidden');

      // Fetch students from the API
      $.ajax({
        url: 'http://127.0.0.1:8000/api/students', // API to get all students
        type: 'GET',
        success: function (response) {
          const students = []; // Assuming response has a "data" key with the list of students


          response.data.map((stud) => {
            console.log(stud, supervisorId)
            if (stud.supervisor_id == supervisorId) {
              students.push(stud)
            }
          })

          // Clear the previous student list
          $('#students-remove-list').empty();

          // Check if there are any students to remove
          if (students.length === 0) {
            $('#students-remove-list').append('<p class="text-center text-gray-500">No students available to remove.</p>');
          } else {
            // Loop through the students and display them
            students.forEach(function (student) {
              const studentDiv = `
            <div class="bg-red-400 text-white p-4 rounded-lg text-center">
              <img alt="Person image" class="mx-auto mb-2 rounded-full" height="50" src="assets/default.jpg" width="50" />
              <p class="font-bold">${student.first_name} ${student.last_name}</p>
              <p class="font-normal">${student.department}</p>
              <button 
                type="button" 
                class="bg-white text-red-400 mt-2 px-4 py-2 rounded-lg hover:bg-gray-200 remove-student-btn" 
                data-student-id="${student.id}">
                Remove This
              </button>
            </div>
          `;

              $('#students-remove-list').append(studentDiv);
            });

            // Attach click event to dynamically added buttons
            $('.remove-student-btn').click(function () {
              const studentId = $(this).data('student-id');


              // Send AJAX request to update supervisor
              $.ajax({
                url: `http://127.0.0.1:8000/api/students/${studentId}/remove-supervisor`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                  supervisor_id: supervisorId
                }),

                success: function (response) {
                  alert(`Student removed successfully.`);
                  // Optionally, refresh the student list or close the modal
                  $(`#add-student-btn[data-student-id="${studentId}"]`).parent().remove();
                  window.location.reload()
                },
                error: function (xhr, status, error) {
                  console.error('Error assigning supervisor:', error);
                  alert('Failed to assign supervisor. Please try again.');
                }
              });

            });
          }
        },
        error: function (xhr, status, error) {
          console.error('Error fetching students:', error);
        }
      });
    });

    // Close the modal
    $('#close-remove-modal-btn').click(function () {
      $('#remove-student-modal').addClass('hidden');
    });

    // Optionally, close the modal when clicking outside of it
    $(window).click(function (event) {
      const modal = $('#remove-student-modal');
      if ($(event.target).is(modal)) {
        modal.addClass('hidden');
      }
    });










    // GET TASKS
    // Function to dynamically generate task rows
    function generateTaskRows(tasks) {
      $('#task-list').empty(); // Clear existing rows

      tasks.forEach(task => {
        // Set colors based on priority and status
        let priorityColor = '';
        let statusColor = '';
        let statusBgColor = '';

        // Priority color logic
        switch (task.priority) {
          case 'High':
            priorityColor = 'bg-red-500'; // Red for High priority
            break;
          case 'Medium':
            priorityColor = 'bg-yellow-500'; // Yellow for Medium priority
            break;
          case 'Low':
            priorityColor = 'bg-green-500'; // Green for Low priority
            break;
          default:
            priorityColor = 'bg-gray-500'; // Default for no priority
            break;
        }

        // Status color logic
        switch (task.status) {
          case 'Completed':
            statusColor = 'bg-green-500'; // Green for Completed
            statusBgColor = 'text-white'; // White text for green
            break;
          case 'Pending':
            statusColor = 'bg-yellow-500'; // Yellow for Pending
            statusBgColor = 'text-white'; // White text for yellow
            break;
          default:
            statusColor = 'bg-gray-500'; // Default color for other status
            statusBgColor = 'text-white';
            break;
        }
        // Create the row with dynamically generated buttons based on task status
        const row = `
          <tr id="task-${task.id}">
            <td class="py-2">
              <div class="bg-white p-4 rounded-lg">${task.description}</div>
            </td>
            <td class="py-2">
              <div class="bg-white p-4 rounded-lg">${task.deadline}</div>
            </td>
            <td class="py-2">
              <div class="bg-white p-4 rounded-lg">${task.assigned_to.first_name} ${task.assigned_to.last_name}</div>
            </td>
            <td class="py-2">
              <div class="bg-[#F2F1EC] p-4 rounded-lg">
                <span class="${priorityColor} text-white px-2 py-1 rounded">${task.priority}</span>
              </div>
            </td>
            <td class="py-2">
              <div class="bg-[#F2F1EC] p-4 rounded-lg">
                <span class="${statusColor} ${statusBgColor} px-2 py-1 rounded">${task.status}</span>
              </div>
            </td>
            <td class="py-2">
              <div class="flex space-x-2">
                <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 delete-task-button" data-task-id="${task.id}">
                  Delete
                </button>
              </div>
            </td>
          </tr>
        `;

        // Append the row to the task list table
        $('#task-list').append(row);
      });
    }

    $(document).on('click', '.delete-task-button', function () {
      const taskId = $(this).data('task-id'); // Get the task ID from the button

      if (confirm('Are you sure you want to delete this task?')) {
        $.ajax({
          url: `http://127.0.0.1:8000/api/tasks/${taskId}`, // API endpoint
          type: 'DELETE',
          success: function (response) {
            alert(response.message); // Show success message
            $(`#task-${taskId}`).remove(); // Remove the task row from the table
          },
          error: function (xhr) {
            const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : 'An error occurred';
            alert(`Failed to delete task: ${errorMessage}`); // Show error message
          },
        });
      }
    });


    // Function to fetch task data from API
    function fetchTasks() {
      $.ajax({
        url: `http://127.0.0.1:8000/api/tasks?supervisor_id=${supervisorId}`,
        method: 'GET',
        success: function (response) {
          if (response) {
            generateTaskRows(response); // Pass the fetched tasks to the row generator
          } else {
            console.error('No tasks data available.');
          }
        },
        error: function (xhr, status, error) {
          console.error('Error fetching tasks:', error);
        }
      });
    }

    // Call the function to fetch and display tasks
    fetchTasks();






    // CREATE TASKS
    // Fetch the list of students

    $(document).ready(function () {

      $.ajax({
        url: 'http://127.0.0.1:8000/api/supervisor/students', // Adjust this route if needed
        type: 'POST',
        data: {
          supervisor_id: supervisorId
        },
        success: function (response) {
          const students = response.data;
          const studentSelect = $('#assigned_to');
          students.map(student => {
            studentSelect.append(new Option(`${student.first_name} ${student.last_name}`, student.id));
          });

        },
        error: function (xhr, status, error) {
          // Handle error
          console.error("Error fetching students:", error);
        }
      })


      // Show the modal when the button is clicked
      $('#addTaskButton').click(function () {
        $('#addTaskModal').show(); // Display modal by changing display to block
      });

      // Close the modal when the close button is clicked
      $('#closeModalButton').click(function () {
        $('#addTaskModal').hide(); // Hide modal by changing display to none
      });

      // Handle form submission
      $('#taskForm').submit(function (event) {
        event.preventDefault(); // Prevent the default form submission

        // Get form data
        const taskData = {
          description: $('#description').val(),
          deadline: $('#deadline').val(),
          priority: $('#priority').val(),
          status: "Pending",
          assigned_to: $('#assigned_to').val(),
          assigned_by: supervisorId // Use the actual supervisor ID
        };

        // Send POST request to create the task
        $.ajax({
          url: "http://127.0.0.1:8000/api/tasks",
          method: "POST",
          data: taskData,
          success: function (response) {
            if (response) {
              alert('Task created successfully!');
              $('#addTaskModal').hide(); // Hide the modal after success
              window.location.reload()
            }
          },
          error: function (xhr, status, error) {
            alert('Error creating task: ' + error);
          }
        });
      });
    })
  </script>

</body>

</html>